{% extends 'base.html' %} {% block title %}Ä°ÅŸler{% endblock %} {% block content %}
<div class="container-fluid py-4">

    <h3 class="mb-4"><i class="bi bi-kanban text-primary"></i> Ä°ÅŸler</h3>

    <!-- ðŸ”¹ Filtre Paneli (Yatay Ã¼stte) -->
    <div class="d-flex flex-wrap align-items-end mb-4 bg-light p-3 shadow rounded">
        <div class="me-3 mb-2">
            <label class="form-label mb-1">Personel</label>
            <select class="form-select" id="personnelFilter">
                <option value="">TÃ¼mÃ¼</option>
            </select>
        </div>
        <div class="me-3 mb-2">
            <label class="form-label mb-1">MÃ¼ÅŸteri</label>
            <select class="form-select" id="customerFilter">
                <option value="">TÃ¼mÃ¼</option>
            </select>
        </div>
        <div class="mb-2">
            <button class="btn btn-primary mt-2" id="applyFilters">Filtrele</button>
        </div>
    </div>

    <div class="d-flex flex-column flex-lg-row">
        <div class="flex-grow-1">

            <!-- ðŸ”¹ AÃ§Ä±k Ä°ÅŸler -->
            <h5 class="mt-2 mb-3 text-primary fw-bold"><i class="bi bi-play-circle-fill me-2"></i> Devam Eden Ä°ÅŸler</h5>
            <div class="row g-3" id="openJobList">
                {% for job in open_jobs %}
                <div class="col-12 col-md-6 col-lg-4 job-item" data-status="{{ job.status }}" data-personnel="{{ job.assigned_users or '' }}" data-customer="{{ job.customer_company }}" data-target="{{ job.target_date }}">
                    <div class="card shadow-sm h-100 position-relative job-card" style="cursor:pointer; transition: transform 0.2s;" onclick="window.location.href='/job/{{ job.job_id }}'" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">

                        <div class="card-body d-flex flex-column">

                            <!-- BaÅŸlÄ±k -->
                            <h5 class="card-title fw-bold text-primary mb-3 text-truncate">
                                <i class="bi bi-kanban-fill me-2"></i> {{ job.title }}
                            </h5>

                            <!-- MÃ¼ÅŸteri -->
                            <p class="mb-1 text-truncate">
                                <strong>MÃ¼ÅŸteri:</strong>
                                <span class="text-info">{{ job.customer_company }}</span>
                                <small class="text-muted">({{ job.customer_code }})</small>
                            </p>

                            <!-- Personel -->
                            <p class="mb-1 text-truncate">
                                <strong>Personel:</strong>
                                <span class="text-secondary">{{ job.assigned_users or 'AtanmamÄ±ÅŸ' }}</span>
                            </p>

                            <!-- Termin -->
                            <p class="mb-1">
                                <strong>Termin:</strong> {% if job.target_date %}
                                <span class="text-warning">{{ job.target_date.strftime("%d.%m.%Y") }}</span> {% else %}
                                <span class="text-muted">BelirtilmemiÅŸ</span> {% endif %}
                            </p>

                            <!-- OluÅŸturulma -->
                            <p class="mb-0 text-muted">
                                <small>OluÅŸturulma: {{ job.job_created_at.strftime("%d.%m.%Y") }}</small>
                            </p>
                        </div>

                        <!-- Durum Badge -->
                        <div class="status-badge position-absolute bottom-0 end-0 m-2 px-3 py-1 rounded-pill bg-warning text-white fw-bold text-uppercase">
                            Devam Ediyor
                        </div>
                    </div>
                </div>

                {% endfor %} {% if open_jobs|length == 0 %}
                <div class="text-muted fst-italic mb-3">HenÃ¼z aÃ§Ä±k iÅŸ bulunmamaktadÄ±r.</div>
                {% endif %}
            </div>

            <!-- ðŸ”¹ Tamamlanan Ä°ÅŸler -->
            <h5 class="mt-5 mb-3 text-success fw-bold"><i class="bi bi-check-circle-fill me-2"></i> Tamamlanan Ä°ÅŸler
            </h5>
            <div class="row g-3" id="closedJobList">
                {% for job in closed_jobs %}
                <div class="col-12 col-md-6 col-lg-4 job-item" data-status="{{ job.status }}" data-personnel="{{ job.assigned_users or '' }}" data-customer="{{ job.customer_company }}" data-target="{{ job.target_date }}">
                    <div class="card shadow-sm h-100 position-relative job-card" style="cursor:pointer; transition: transform 0.2s;" onclick="window.location.href='/job/{{ job.job_id }}'" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">

                        <div class="card-body d-flex flex-column">

                            <!-- BaÅŸlÄ±k -->
                            <h5 class="card-title fw-bold text-primary mb-3 text-truncate">
                                <i class="bi bi-kanban-fill me-2"></i> {{ job.title }}
                            </h5>

                            <!-- MÃ¼ÅŸteri -->
                            <p class="mb-1 text-truncate">
                                <strong>MÃ¼ÅŸteri:</strong>
                                <span class="text-info">{{ job.customer_company }}</span>
                                <small class="text-muted">({{ job.customer_code }})</small>
                            </p>

                            <!-- Personel -->
                            <p class="mb-1 text-truncate">
                                <strong>Personel:</strong>
                                <span class="text-secondary">{{ job.assigned_users or 'AtanmamÄ±ÅŸ' }}</span>
                            </p>

                            <!-- Termin -->
                            <p class="mb-1">
                                <strong>Termin:</strong> {% if job.target_date %}
                                <span class="text-warning">{{ job.target_date.strftime("%d.%m.%Y") }}</span> {% else %}
                                <span class="text-muted">BelirtilmemiÅŸ</span> {% endif %}
                            </p>

                            <!-- OluÅŸturulma -->
                            <p class="mb-0 text-muted">
                                <small>OluÅŸturulma: {{ job.job_created_at.strftime("%d.%m.%Y") }}</small>
                            </p>
                        </div>

                        <!-- Durum Badge -->
                        <div class="status-badge position-absolute bottom-0 end-0 m-2 px-3 py-1 rounded-pill bg-success text-white fw-bold text-uppercase">
                            TamamlandÄ±
                        </div>
                    </div>
                </div>

                {% endfor %} {% if closed_jobs|length == 0 %}
                <div class="text-muted fst-italic mb-3">HenÃ¼z tamamlanan iÅŸ bulunmamaktadÄ±r.</div>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- ðŸ”¹ Yeni Ä°ÅŸ Ekle Butonu -->
    <a href="/job_create" class="btn btn-primary rounded-circle shadow-lg d-flex justify-content-center align-items-center position-fixed" style="bottom: 40px; right: 40px; width: 60px; height: 60px; font-size: 24px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'"
        onmouseout="this.style.transform='scale(1)'">
        <i class="bi bi-plus"></i>
    </a>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const items = document.querySelectorAll('.job-item');
        const personnelSet = new Set();
        const customerSet = new Set();

        items.forEach(item => {
            item.dataset.personnel.split(',').map(p => p.trim()).filter(p => p).forEach(p =>
                personnelSet.add(p));
            if (item.dataset.customer) customerSet.add(item.dataset.customer.trim());
        });

        const personnelSelect = document.getElementById('personnelFilter');
        Array.from(personnelSet).sort().forEach(p => {
            const option = document.createElement('option');
            option.value = p;
            option.textContent = p;
            personnelSelect.appendChild(option);
        });

        const customerSelect = document.getElementById('customerFilter');
        Array.from(customerSet).sort().forEach(c => {
            const option = document.createElement('option');
            option.value = c;
            option.textContent = c;
            customerSelect.appendChild(option);
        });

        function applyFilters() {
            const personnelValue = personnelSelect.value;
            const customerValue = customerSelect.value;

            let visibleCount = 0;
            items.forEach(item => {
                let visible = true;
                if (personnelValue && !item.dataset.personnel.split(',').map(p => p.trim()).includes(
                        personnelValue)) visible = false;
                if (customerValue && item.dataset.customer !== customerValue) visible = false;

                item.style.display = visible ? '' : 'none';
                if (visible) visibleCount++;
            });
        }

        document.getElementById('applyFilters').addEventListener('click', applyFilters);
    });
</script>

{% endblock %}