{% extends 'base.html' %} {% block title %}{{ topic.title }}{% endblock %} {% block content %}
<div class="container-fluid py-4">
    <a href="/bilgi_bankasi" class="btn btn-outline-secondary mb-3">
        <i class="bi bi-arrow-left"></i> Geri
    </a>

    <div class="card shadow-sm">
        <div class="card-body">
            <h4 class="fw-bold text-primary">{{ topic.title }}</h4>
            <p>{{ topic.description }}</p>
            <p class="text-muted"><small>OluÅŸturan: {{ topic.username }} |
                    {{ topic.created_at.strftime("%d.%m.%Y") }}</small></p>
        </div>
    </div>

    <!-- ðŸ”¹ Mesajlar / Yorumlar -->
    <div class="mt-4">
        <h5>Mesajlar</h5>
        <div class="list-group mb-3" id="messagesList">
            <div class="list-group mb-3" id="messagesList">
                {% for msg in messages %}
                <div class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{{ msg.username }}</strong>
                        <small class="text-muted">{{ msg.created_at.strftime("%d.%m.%Y %H:%M") }}</small>
                        <p>{{ msg.content }}</p>
                        {% if msg.image %}
                        <a href="/{{ msg.image }}" target="_blank">
                            <img src="/{{ msg.image }}" class="img-fluid rounded mb-2" style="max-height:200px; cursor:pointer;">
                        </a>
                        {% endif %}
                    </div>
                    {% if request.session.user.id == msg.user_id %}
                    <!-- DÃ¼zenle ve Sil ButonlarÄ± -->
                    <div class="d-flex flex-column gap-1 ms-3">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editMessageModal{{ msg.id }}">DÃ¼zenle</button>
                        <form action="/bilgi_bankasi/{{ topic.id }}/message/{{ msg.id }}/delete" method="POST">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Sil</button>
                        </form>
                    </div>

                    <!-- DÃ¼zenleme Modal -->
                    <div class="modal fade" id="editMessageModal{{ msg.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form action="/bilgi_bankasi/{{ topic.id }}/message/{{ msg.id }}/edit" method="POST" enctype="multipart/form-data">
                                    <div class="modal-header">
                                        <h5 class="modal-title">MesajÄ± DÃ¼zenle</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <textarea class="form-control mb-2" name="content" rows="3" required>{{ msg.content }}</textarea>
                                        <label for="editImage{{ msg.id }}" class="form-label">Resim (Opsiyonel)</label>
                                        <input type="file" class="form-control" name="image" id="editImage{{ msg.id }}" accept="image/*">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                                        <button type="submit" class="btn btn-primary">GÃ¼ncelle</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %} {% if messages|length == 0 %}
                <div class="text-muted fst-italic">HenÃ¼z mesaj yok.</div>
                {% endif %}
            </div>

        </div>
        <!-- Modal -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-transparent border-0">
                    <div class="modal-body p-0 text-center">
                        <img id="modalImage" src="" class="img-fluid rounded">
                    </div>
                </div>
            </div>
        </div>
        <!-- ðŸ”¹ Yeni Mesaj Formu -->
        <form action="/bilgi_bankasi/{{ topic.id }}/messages" method="POST" enctype="multipart/form-data" class="d-flex flex-column gap-2">
            <div class="input-group">
                <textarea class="form-control" name="content" id="content" rows="3" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                <label for="image" class="input-group-text" style="cursor:pointer;">
                 <i class="bi bi-image"></i>
             </label>
                <input type="file" class="d-none" name="image" id="image" accept="image/*">
            </div>
            <!-- user_id artÄ±k session'dan alÄ±nÄ±yor, hidden input gerek yok -->
            <button type="submit" class="btn btn-primary mt-2 align-self-end">GÃ¶nder</button>
        </form>

    </div>
</div>
<img id="preview" class="img-fluid rounded mt-2" style="max-height:150px; display:none;">
<script>
    const imageInput = document.getElementById('image');
    const preview = document.getElementById('preview');
    imageInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(this.files[0]);
        } else {
            preview.style.display = 'none';
        }
    });
</script>
<script>
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');

    modal.addEventListener('show.bs.modal', function(event) {
        const img = event.relatedTarget;
        const src = img.getAttribute('data-img');
        modalImg.src = src;
    });
</script>
{% endblock %}